#!/bin/sh
# this script generates omfonts.map, vf/, tfm/

# Split each om-font into two fonts: lower half (om->xx) and upper half (om->yy),
# in order to be able to use appropriate Type1 font for each half (lower half in
# each om-font is exactly equal to corresponding cm-font; upper half in all om-fonts
# is the same).

cd /tmp; rm -fr vf ~/lhplain/vf ~/lhplain/tfm; mkdir vf ~/lhplain/vf ~/lhplain/tfm; cd vf
echo '% this file was generated by gen-vf' >~/lhplain/omfonts.map

for i in `sed -n '/% \w\+[0-9]\+$/s/\(\w\+[0-9]\+\).*% /\1_/p' ~/lhplain/cmfonts.map`; do
  cm=${i%_*}
  sf=${i#*_}
  om=om${cm#cm}
  xx=xx${cm#cm}
  yy=yy${cm#cm}
  printf '%s %s <%s.pfb\n' $xx $(echo $cm|tr a-z A-Z) $cm >>~/lhplain/omfonts.map
  printf '%s %s "OMEncoding ReEncodeFont" <cm-super-om.enc <%s.pfb\n' \
                           $yy $(echo $sf|tr a-z A-Z) $sf >>~/lhplain/omfonts.map
  tftopl ~/tex/TeXfonts/$om.tfm >$om.vpl
  dsize=$(sed -n 's/^(DESIGNSIZE/(FONTDSIZE/p' $om.vpl)
  sed -i "1i (MAPFONT D 0 (FONTNAME $xx) $dsize)" $om.vpl
  sed -i "1a (MAPFONT D 1 (FONTNAME $yy) $dsize)" $om.vpl
  sed -i 's/^(CHARACTER O \([23][0-9][0-9]\)/&\n   (MAP (SELECTFONT D 1) (SETCHAR O \1))/' $om.vpl
  ln -s ~/tex/TeXfonts/$om.tfm $xx.tfm
  ln -s ~/tex/TeXfonts/$om.tfm $yy.tfm
  vptovf $om.vpl
  mv $om.vf ~/lhplain/vf/
  ln -s ../../tex/TeXfonts/$om.tfm ~/lhplain/tfm/$xx.tfm
  ln -s ../../tex/TeXfonts/$om.tfm ~/lhplain/tfm/$yy.tfm
done
sed -i 's/SFTEX/SFTT/;s/<sftex/<sftt/' ~/lhplain/omfonts.map
